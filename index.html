<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Social</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">

<nav class="bg-slate-800 p-4 flex justify-between items-center">
  <div class="flex items-center gap-3">
    <div class="text-xl font-bold">Mini Social</div>
  </div>
  <div id="nav-right" class="hidden items-center gap-3">
    <img id="nav-avatar" class="w-9 h-9 rounded-full" src="" alt="avatar"/>
    <div id="nav-name" class="text-sm"></div>
    <button onclick="logout()" class="bg-rose-500 px-3 py-1 rounded">Logout</button>
  </div>
</nav>

<!-- AUTH -->
<section id="auth-container" class="max-w-2xl mx-auto mt-8 p-6">
  <div id="login-card" class="bg-slate-800 rounded-lg p-6 shadow">
    <h2 class="text-2xl mb-4">Login</h2>
    <input id="email" placeholder="Email" class="w-full p-2 mb-3 rounded bg-slate-700"/>
    <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-3 rounded bg-slate-700"/>
    <div class="flex gap-2">
      <button onclick="login()" class="bg-sky-500 px-4 py-2 rounded">Login</button>
      <button onclick="showRegister()" class="bg-transparent border border-slate-600 px-4 py-2 rounded">Register</button>
    </div>
  </div>

  <div id="register-card" class="hidden bg-slate-800 rounded-lg p-6 shadow mt-6">
    <h2 class="text-2xl mb-4">Register</h2>
    <input id="reg-name" placeholder="Name" class="w-full p-2 mb-2 rounded bg-slate-700"/>
    <input id="reg-handle" placeholder="Handle" class="w-full p-2 mb-2 rounded bg-slate-700"/>
    <input id="reg-email" placeholder="Email" class="w-full p-2 mb-2 rounded bg-slate-700"/>
    <input id="reg-password" type="password" placeholder="Password" class="w-full p-2 mb-2 rounded bg-slate-700"/>
    <input id="reg-avatar" type="file" class="mb-3"/>
    <div class="flex gap-2">
      <button onclick="register()" class="bg-emerald-500 px-4 py-2 rounded">Create account</button>
      <button onclick="showLogin()" class="bg-transparent border border-slate-600 px-4 py-2 rounded">Back</button>
    </div>
  </div>
</section>

<!-- APP -->
<main id="app" class="hidden max-w-5xl mx-auto mt-6 grid grid-cols-3 gap-6">
  <!-- Feed -->
  <div class="col-span-2">
    <div class="bg-slate-800 p-4 rounded mb-4">
      <textarea id="post-text" placeholder="What's happening?" class="w-full p-3 rounded bg-slate-700"></textarea>
      <input id="post-image" type="file" class="mt-2"/>
      <div class="flex justify-end mt-2">
        <button onclick="createPost()" class="bg-sky-500 px-4 py-2 rounded">Post</button>
      </div>
    </div>

    <div id="feed"></div>
  </div>

  <!-- Sidebar -->
  <aside>
    <div class="bg-slate-800 p-4 rounded mb-4">
      <h3 class="text-lg font-semibold mb-3">Suggested</h3>
      <div id="suggested-users" class="space-y-3"></div>
    </div>

    <div class="bg-slate-800 p-4 rounded">
      <h3 class="text-lg font-semibold mb-2">Your ID (for debug)</h3>
      <div id="my-id" class="text-sm text-slate-300"></div>
    </div>
  </aside>
</main>

<script>
const API = ''; // Leave empty when frontend served by same server. If separate, set to backend base URL.
let token = localStorage.getItem('token');
let me = null;

if (token) {
  // decode token to get user id (quickly) OR rely on login/register response to set me.
  // We'll fetch a quick profile by reading token payload if needed.
  // For simplicity the backend returns user object on login/register; so if page reloads we need to fetch suggested to get my id.
  showApp();
  fetchSuggested();
  fetchFeed();
}

function showRegister(){
  document.getElementById('login-card').classList.add('hidden');
  document.getElementById('register-card').classList.remove('hidden');
}
function showLogin(){
  document.getElementById('register-card').classList.add('hidden');
  document.getElementById('login-card').classList.remove('hidden');
}
function showApp(user){
  document.getElementById('auth-container').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  document.getElementById('nav-right').classList.remove('hidden');
  if (user) {
    me = user;
    document.getElementById('nav-avatar').src = API + (user.avatar_url || '/uploads/default.png');
    document.getElementById('nav-name').textContent = user.name;
    document.getElementById('my-id').textContent = user.id;
  }
}

function logout(){
  localStorage.removeItem('token');
  token = null;
  me = null;
  location.reload();
}

async function login(){
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const res = await fetch(API + '/api/login', {
    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email, password })
  });
  const data = await res.json();
  if (data.token){
    localStorage.setItem('token', data.token);
    token = data.token;
    showApp(data.user);
    fetchFeed();
    fetchSuggested();
  } else {
    alert(data.error || 'Login failed');
  }
}

async function register(){
  const form = new FormData();
  form.append('name', document.getElementById('reg-name').value);
  form.append('handle', document.getElementById('reg-handle').value);
  form.append('email', document.getElementById('reg-email').value);
  form.append('password', document.getElementById('reg-password').value);
  const avatar = document.getElementById('reg-avatar').files[0];
  if (avatar) form.append('avatar', avatar);

  const res = await fetch(API + '/api/register', { method: 'POST', body: form });
  const data = await res.json();
  if (data.token){
    localStorage.setItem('token', data.token);
    token = data.token;
    showApp(data.user);
    fetchFeed();
    fetchSuggested();
  } else {
    alert(data.error || 'Register failed');
  }
}

async function fetchFeed(){
  const res = await fetch(API + '/api/posts');
  const posts = await res.json();
  const feed = document.getElementById('feed');
  feed.innerHTML = '';
  posts.forEach(p => {
    feed.insertAdjacentHTML('beforeend', postHTML(p));
  });
}

function postHTML(p){
  const imageMark = p.image_url ? `<img src="${API + p.image_url}" class="mt-3 rounded max-h-96 object-cover w-full"/>` : '';
  const avatar = p.user_avatar ? API + p.user_avatar : '/uploads/default.png';
  return `
  <article class="bg-slate-800 p-4 rounded mb-4" id="post-${p.id}">
    <div class="flex items-center gap-3">
      <img src="${avatar}" class="w-10 h-10 rounded-full"/>
      <div><div class="font-semibold">${escapeHtml(p.user_name)}</div><div class="text-sm text-slate-400">@${escapeHtml(p.user_handle)}</div></div>
    </div>

    <div class="mt-3 text-slate-200">${escapeHtml(p.text || '')}</div>
    ${imageMark}

    <div class="flex gap-4 items-center mt-3 text-sm text-slate-300">
      <button onclick="likePost('${p.id}')" class="flex items-center gap-2">‚ù§Ô∏è <span id="likes-${p.id}">${p.likes || 0}</span></button>
      <button onclick="toggleComments('${p.id}')" class="flex items-center gap-2">üí¨ <span>${p.comment_count || 0}</span></button>
      <div class="ml-auto text-xs text-slate-400">${new Date(p.created_at).toLocaleString()}</div>
    </div>

    <div id="comments-${p.id}" class="hidden mt-3"></div>
  </article>
  `;
}

function escapeHtml(s){
  if (!s) return '';
  return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
}

async function createPost(){
  if (!token){ alert('Login first'); return; }
  const form = new FormData();
  form.append('text', document.getElementById('post-text').value);
  const img = document.getElementById('post-image').files[0];
  if (img) form.append('image', img);
  const res = await fetch(API + '/api/posts', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + token },
    body: form
  });
  if (res.ok){
    document.getElementById('post-text').value = '';
    document.getElementById('post-image').value = '';
    fetchFeed();
  } else {
    const e = await res.json();
    alert(e.error || 'Failed to create post');
  }
}

async function likePost(postId){
  if (!token){ alert('Login first'); return; }
  const res = await fetch(API + '/api/posts/' + postId + '/like', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + token }
  });
  if (res.ok){
    const data = await res.json();
    const el = document.getElementById('likes-' + postId);
    if (el) el.textContent = data.likes;
  }
}

async function toggleComments(postId){
  const container = document.getElementById('comments-' + postId);
  if (!container.classList.contains('hidden')){
    container.classList.add('hidden');
    return;
  }
  // fetch comments
  const res = await fetch(API + `/api/posts/${postId}/comments`);
  const comments = await res.json();
  container.innerHTML = `
    <div class="space-y-2">
      ${comments.map(c => `
        <div class="bg-slate-700 p-2 rounded">
          <div class="text-sm font-semibold">${escapeHtml(c.user_name)} <span class="text-xs text-slate-400">@${escapeHtml(c.user_handle)}</span></div>
          <div class="mt-1 text-slate-200">${escapeHtml(c.text)}</div>
        </div>
      `).join('')}
      <div class="flex gap-2 mt-2">
        <input id="comment-input-${postId}" placeholder="Write a comment..." class="flex-1 p-2 rounded bg-slate-700"/>
        <button onclick="addComment('${postId}')" class="bg-sky-500 px-3 py-1 rounded">Post</button>
      </div>
    </div>
  `;
  container.classList.remove('hidden');
}

async function addComment(postId){
  if (!token){ alert('Login first'); return; }
  const textEl = document.getElementById(`comment-input-${postId}`);
  const text = textEl.value.trim();
  if (!text) return;
  const res = await fetch(API + `/api/posts/${postId}/comments`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ text })
  });
  if (res.ok){
    toggleComments(postId); // will refresh comments
    toggleComments(postId);
  } else {
    const e = await res.json();
    alert(e.error || 'Failed to post comment');
  }
}

async function fetchSuggested(){
  const res = await fetch(API + '/api/users/suggested', {
    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
  });
  const users = await res.json();
  const cont = document.getElementById('suggested-users');
  cont.innerHTML = '';
  users.forEach(u => {
    const avatar = u.avatar_url ? API + u.avatar_url : '/uploads/default.png';
    const isFollowing = !!u.is_following;
    const btnText = isFollowing ? 'Unfollow' : 'Follow';
    const btnClass = isFollowing ? 'bg-rose-500' : 'bg-emerald-500';
    cont.insertAdjacentHTML('beforeend', `
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <img src="${avatar}" class="w-10 h-10 rounded-full"/>
          <div>
            <div class="font-medium">${escapeHtml(u.name)}</div>
            <div class="text-sm text-slate-400">@${escapeHtml(u.handle)}</div>
          </div>
        </div>
        <div>
          <button onclick="toggleFollow('${u.id}', this)" class="${btnClass} px-3 py-1 rounded text-sm">${btnText}</button>
        </div>
      </div>
    `);
  });
}

async function toggleFollow(targetId, btn){
  if (!token){ alert('Login first'); return; }
  const currentlyFollowing = btn.textContent.trim().toLowerCase() === 'unfollow';
  const url = API + `/api/users/${targetId}/${currentlyFollowing ? 'unfollow' : 'follow'}`;
  const res = await fetch(url, { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } });
  if (res.ok){
    // toggle UI
    btn.textContent = currentlyFollowing ? 'Follow' : 'Unfollow';
    btn.classList.toggle('bg-emerald-500');
    btn.classList.toggle('bg-rose-500');
  } else {
    const e = await res.json();
    alert(e.error || 'Failed');
  }
}
</script>
</body>
</html>
