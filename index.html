<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniSocial</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <!-- Navbar -->
  <nav class="bg-white shadow p-4 flex justify-between">
    <h1 class="text-xl font-bold">MiniSocial</h1>
    <div id="auth-buttons">
      <button onclick="showLogin()" class="bg-blue-500 text-white px-4 py-2 rounded">Login</button>
      <button onclick="showSignup()" class="bg-green-500 text-white px-4 py-2 rounded">Signup</button>
    </div>
  </nav>

  <!-- Post Composer -->
  <div id="composer" class="max-w-xl mx-auto mt-6 hidden bg-white p-4 shadow rounded">
    <textarea id="postText" placeholder="What's on your mind?" class="w-full p-2 border rounded mb-2"></textarea>
    <button onclick="createPost()" class="bg-blue-500 text-white px-4 py-2 rounded">Post</button>
  </div>

  <!-- Feed -->
  <div id="feed" class="max-w-xl mx-auto mt-6 space-y-4"></div>

  <!-- Login Modal -->
  <div id="loginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded w-80">
      <h2 class="text-lg font-bold mb-4">Login</h2>
      <input id="loginEmail" type="email" placeholder="Email" class="w-full p-2 border rounded mb-2">
      <input id="loginPassword" type="password" placeholder="Password" class="w-full p-2 border rounded mb-4">
      <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Login</button>
      <button onclick="closeModals()" class="mt-2 text-gray-500 w-full">Cancel</button>
    </div>
  </div>

  <!-- Signup Modal -->
  <div id="signupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded w-80">
      <h2 class="text-lg font-bold mb-4">Signup</h2>
      <input id="signupName" placeholder="Name" class="w-full p-2 border rounded mb-2">
      <input id="signupHandle" placeholder="Username" class="w-full p-2 border rounded mb-2">
      <input id="signupEmail" type="email" placeholder="Email" class="w-full p-2 border rounded mb-2">
      <input id="signupPassword" type="password" placeholder="Password" class="w-full p-2 border rounded mb-4">
      <button onclick="signup()" class="bg-green-500 text-white px-4 py-2 rounded w-full">Signup</button>
      <button onclick="closeModals()" class="mt-2 text-gray-500 w-full">Cancel</button>
    </div>
  </div>

<script>
const API = window.location.origin.includes("localhost") 
  ? "http://localhost:4000" 
  : window.location.origin;
let token = localStorage.getItem("token") || null;

function showLogin(){ document.getElementById('loginModal').classList.remove('hidden'); }
function showSignup(){ document.getElementById('signupModal').classList.remove('hidden'); }
function closeModals(){ document.querySelectorAll('#loginModal,#signupModal').forEach(m=>m.classList.add('hidden')); }

function renderFeed(posts){
  const feed = document.getElementById('feed');
  feed.innerHTML = '';
  posts.forEach(p=>{
    feed.innerHTML += `
      <div class="bg-white p-4 shadow rounded">
        <div class="flex justify-between mb-2">
          <span class="font-bold">${p.name} (@${p.handle})</span>
          <span class="text-sm text-gray-500">${new Date(p.created_at).toLocaleString()}</span>
        </div>
        <p>${p.text}</p>
        <div class="mt-2">
          <button onclick="likePost('${p.id}')" class="text-blue-500">❤️ ${p.likes || 0}</button>
        </div>
      </div>
    `;
  });
}

function fetchPosts(){
  fetch(API + '/posts')
    .then(res=>res.json())
    .then(renderFeed)
    .catch(console.error);
}

function signup(){
  fetch(API+'/signup',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      name: document.getElementById('signupName').value,
      handle: document.getElementById('signupHandle').value,
      email: document.getElementById('signupEmail').value,
      password: document.getElementById('signupPassword').value
    })
  }).then(r=>r.json()).then(data=>{
    if(data.token){ localStorage.setItem('token',data.token); token=data.token; closeModals(); document.getElementById('composer').classList.remove('hidden'); }
  });
}

function login(){
  fetch(API+'/login',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      email: document.getElementById('loginEmail').value,
      password: document.getElementById('loginPassword').value
    })
  }).then(r=>r.json()).then(data=>{
    if(data.token){ localStorage.setItem('token',data.token); token=data.token; closeModals(); document.getElementById('composer').classList.remove('hidden'); }
  });
}

function createPost(){
  fetch(API+'/posts',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
    body:JSON.stringify({ text: document.getElementById('postText').value })
  }).then(()=>{ document.getElementById('postText').value=''; fetchPosts(); });
}

function likePost(id){
  fetch(API+'/posts/'+id+'/like',{method:'POST', headers:{'Authorization':'Bearer '+token}})
    .then(()=>fetchPosts());
}

fetchPosts();
</script>
</body>
</html>
