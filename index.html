<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Magic Social</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f0f2f5; }
    .post, .comment, .user-suggest { background: white; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .post-header, .comment-header { display: flex; align-items: center; gap: 10px; }
    .post-image { max-width: 100%; border-radius: 6px; margin-top: 5px; }
    .btn { background: #007bff; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; }
    .btn.red { background: #dc3545; }
    .btn.gray { background: #6c757d; }
    .comments { margin-left: 50px; margin-top: 5px; }
    .comment-form { display: flex; gap: 4px; margin-top: 5px; }
    #sidebar { position: fixed; right: 20px; top: 20px; width: 200px; }
  </style>
</head>
<body>

<h1>Magic Social</h1>

<div id="auth-section">
  <h3>Register</h3>
  <form id="register-form">
    <input name="name" placeholder="Name" required />
    <input name="handle" placeholder="Handle" required />
    <input name="email" placeholder="Email" required />
    <input name="password" type="password" placeholder="Password" required />
    <input name="avatar" type="file" accept="image/*" />
    <button class="btn">Register</button>
  </form>

  <h3>Login</h3>
  <form id="login-form">
    <input name="email" placeholder="Email" required />
    <input name="password" type="password" placeholder="Password" required />
    <button class="btn">Login</button>
  </form>
</div>

<div id="post-section" style="display:none;">
  <form id="post-form" enctype="multipart/form-data">
    <textarea name="text" placeholder="What's happening?" required></textarea><br>
    <input type="file" name="image" accept="image/*" /><br>
    <button class="btn">Post</button>
  </form>

  <h2>Posts</h2>
  <div id="posts"></div>
</div>

<div id="sidebar">
  <h3>Suggested Users</h3>
  <div id="suggested"></div>
</div>

<script>
const API = location.origin + '/api';
let token = localStorage.getItem('token');
let currentUser = JSON.parse(localStorage.getItem('user') || 'null');

// ---------------- AUTH ----------------
document.getElementById('register-form').addEventListener('submit', async e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch(API + '/register', { method: 'POST', body: fd });
  const data = await res.json();
  if (data.token) {
    token = data.token;
    currentUser = data.user;
    localStorage.setItem('token', token);
    localStorage.setItem('user', JSON.stringify(currentUser));
    showApp();
  } else alert(data.error || 'Registration failed');
});

document.getElementById('login-form').addEventListener('submit', async e => {
  e.preventDefault();
  const body = Object.fromEntries(new FormData(e.target));
  const res = await fetch(API + '/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
  const data = await res.json();
  if (data.token) {
    token = data.token;
    currentUser = data.user;
    localStorage.setItem('token', token);
    localStorage.setItem('user', JSON.stringify(currentUser));
    showApp();
  } else alert(data.error || 'Login failed');
});

// ---------------- POSTS ----------------
document.getElementById('post-form').addEventListener('submit', async e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch(API + '/posts', { method: 'POST', headers: { Authorization: 'Bearer ' + token }, body: fd });
  if (!res.ok) return alert('Post failed');
  e.target.reset();
});

async function fetchPosts() {
  const res = await fetch(API + '/posts');
  const posts = await res.json();
  renderPosts(posts);
}

function renderPosts(posts) {
  const container = document.getElementById('posts');
  container.innerHTML = '';
  posts.forEach(p => {
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `
      <div class="post-header">
        <img src="${p.user_avatar || 'https://via.placeholder.com/40'}" class="avatar" />
        <strong>@${p.user_handle}</strong> &nbsp; <small>${new Date(p.created_at).toLocaleString()}</small>
      </div>
      <div>${p.text || ''}</div>
      ${p.image_url ? `<img src="${p.image_url}" class="post-image" />` : ''}
      <div>
        <button class="btn gray like-btn" data-id="${p.id}">‚ù§Ô∏è ${p.likes || 0}</button>
        <button class="btn gray comment-toggle" data-id="${p.id}">üí¨ ${p.comment_count}</button>
        ${currentUser?.id === p.user_id ? `<button class="btn red delete-btn" data-id="${p.id}">Delete</button>` : ''}
      </div>
      <div class="comments" id="comments-${p.id}" style="display:none;"></div>
    `;
    container.appendChild(div);
  });
}

// ---------------- COMMENTS ----------------
async function fetchComments(postId) {
  const res = await fetch(`${API}/posts/${postId}/comments`);
  const comments = await res.json();
  const container = document.getElementById(`comments-${postId}`);
  container.innerHTML = comments.map(c => `
    <div class="comment">
      <div class="comment-header">
        <img src="${c.user_avatar || 'https://via.placeholder.com/40'}" class="avatar" />
        <strong>@${c.user_handle}</strong> &nbsp; <small>${new Date(c.created_at).toLocaleString()}</small>
      </div>
      <div>${c.text}</div>
    </div>
  `).join('') + (token ? `
    <form class="comment-form" data-id="${postId}">
      <input name="text" placeholder="Write a comment..." required />
      <button class="btn gray">Send</button>
    </form>
  ` : '');
}

// ---------------- SUGGESTED USERS ----------------
async function fetchSuggested() {
  const res = await fetch(API + '/users/suggested');
  const users = await res.json();
  document.getElementById('suggested').innerHTML = users.map(u => `
    <div class="user-suggest">
      <img src="${u.avatar_url || 'https://via.placeholder.com/40'}" class="avatar" />
      @${u.handle}
    </div>
  `).join('');
}

// ---------------- EVENTS ----------------
document.addEventListener('click', async e => {
  if (e.target.classList.contains('delete-btn')) {
    await fetch(API + '/posts/' + e.target.dataset.id, { method: 'DELETE', headers: { Authorization: 'Bearer ' + token } });
  }
  if (e.target.classList.contains('like-btn')) {
    await fetch(API + `/posts/${e.target.dataset.id}/like`, { method: 'POST', headers: { Authorization: 'Bearer ' + token } });
  }
  if (e.target.classList.contains('comment-toggle')) {
    const cid = e.target.dataset.id;
    const cdiv = document.getElementById(`comments-${cid}`);
    if (cdiv.style.display === 'none') {
      await fetchComments(cid);
      cdiv.style.display = 'block';
    } else {
      cdiv.style.display = 'none';
    }
  }
});
document.addEventListener('submit', async e => {
  if (e.target.classList.contains('comment-form')) {
    e.preventDefault();
    const postId = e.target.dataset.id;
    const body = { text: e.target.text.value };
    await fetch(API + `/posts/${postId}/comments`, {
      method: 'POST',
      headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    e.target.reset();
    await fetchComments(postId);
  }
});

// ---------------- LOOP ----------------
function showApp() {
  document.getElementById('auth-section').style.display = 'none';
  document.getElementById('post-section').style.display = 'block';
}
if (token) showApp();

setInterval(() => {
  fetchPosts();
  fetchSuggested();
}, 250);

</script>
</body>
</html>
